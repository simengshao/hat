<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tutorial to Use the HAT Package in R • hat</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial to Use the HAT Package in R">
<meta property="og:description" content="hat">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">hat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/my-vignette.html">Tutorial to Use the HAT Package in R</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="my-vignette_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Tutorial to Use the HAT Package in R</h1>
            
      
      
      <div class="hidden name"><code>my-vignette.Rmd</code></div>

    </div>

    
    
<div class="section level3">
<h3 id="simeng-shao">Simeng Shao<a class="anchor" aria-label="anchor" href="#simeng-shao"></a>
</h3>
<div class="section level4">
<h4 id="february-25-2021">February 25, 2021<a class="anchor" aria-label="anchor" href="#february-25-2021"></a>
</h4>
<p>The <code>hat</code> package implements a hierarchical aggregation testing algorithm, as described in the paper “Controlling the False Split Rate in Tree-Based Aggregation”. The package implements a hierarchical testing function that determines how to aggregate leaves with while controlling the <em>false split rate</em> (FSR), an error measure defined in the above paper. There are two primary use cases considered in the paper:</p>
<ol style="list-style-type: decimal">
<li><p>aggregating observations with the same means and</p></li>
<li><p>aggregating features with the same coefficients in linear regression.</p></li>
</ol>
<p>We provide examples of these two use cases and then demonstrate a more general example of the hierarchical aggregation procedure.</p>
<ul>
<li><a href="#observation">Application to observation aggregation</a></li>
<li><a href="#feature">Application to feature aggregation</a></li>
<li><a href="#general">General example</a></li>
</ul>
<p><a id="observation"></a></p>
</div>
</div>
<div class="section level2">
<h2 id="application-to-observation-aggregation">Application to observation aggregation<a class="anchor" aria-label="anchor" href="#application-to-observation-aggregation"></a>
</h2>
<div class="section level3">
<h3 id="brief-look-at-the-data">Brief look at the data<a class="anchor" aria-label="anchor" href="#brief-look-at-the-data"></a>
</h3>
<p>This section is an example of using the package to achieve aggregation of observations based on their means. We calculate volatility of daily stocks price data that are derived from the US Stock Database ©2021 Center for Research in Security Prices (CRSP), The University of Chicago Booth School of Business <span class="citation">CRSP Stocks (2021)</span>.</p>
<p>The tree structure is constructed based on the North American Industry Classification System (<a href="https://www.census.gov/naics/" class="external-link">NAICS</a>), an industry classification system that employs a six digit code: the first two digits designate the largest sector; the third, fourth, fifth and sixth digits designate the subsector, industry group, industry, and national industry, respectively.</p>
<p>One can load the volatility data and pre-trained tree structure into our environment:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">hat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">stocks_volatility</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2538</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">stocks_volatility</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "ID"         "name"       "volatility"</span></span></code></pre></div>
<p>The <code>stocks_volatility</code> data set contains 2538 stocks’ corresponding company names and the volatility during the 5-year period.</p>
<p>The distribution of volatility is right-skewed. Therefore, in our analysis, we will take the logarithm to reduce skew.</p>
<p>The tree structure is saved in <code>stocks_tree</code>, which is formed according to the NAICS hierarchy. We can look at the tree structure by using the function <code><a href="../reference/plot_tree.html">plot_tree()</a></code>. However, we omit this for now because we will see the tree again very soon.</p>
</div>
<div class="section level3">
<h3 id="aggregating-observations">Aggregating observations<a class="anchor" aria-label="anchor" href="#aggregating-observations"></a>
</h3>
<p>The idea of aggregation is based on the fact that some companies might share the same mean volatility of stock if they are “similar enough” in the tree. We assume a model</p>
<p><span class="math display">\[
y_i = \theta_{k(i)} + \epsilon_i, \ \ \ k(i)\in\{1,...,K\}, i\in \{1, ..., p\},
\]</span></p>
<p>where, in the stocks example, <span class="math inline">\(y_i\)</span> is the volatility of the <span class="math inline">\(i\)</span>-th stock. We will use the tree as a guide as it describes the similarity among companies and therefore helps narrow down reasonable aggregations to consider.</p>
<p>Our algorithm achieves aggregation in two main steps:</p>
<ol style="list-style-type: decimal">
<li><p>Generate a p-value by an ANOVA test for each interior node.</p></li>
<li><p>Use the hierarchical aggregation testing procedure to sequentially go down the tree in a fashion that will control the FSR of the overall aggregation of leaves that is produced.</p></li>
</ol>
<p>The function <code>aggregate_observations</code> performs both of these steps:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">=</span> <span class="fu"><a href="../reference/aggregate_observations.html">aggregate_observations</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">stocks_volatility</span><span class="op">$</span><span class="va">volatility</span><span class="op">)</span>, </span>
<span>                       sigma <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>                       tree <span class="op">=</span> <span class="va">stocks_tree</span>, </span>
<span>                       alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Nodes 3240 at level 1 are rejected."</span></span>
<span><span class="co">#&gt; [1] "Now moving to depth 2"</span></span>
<span><span class="co">#&gt; [1] "The rejected nodes in level 2 are 3222"</span></span>
<span><span class="co">#&gt; [2] "The rejected nodes in level 2 are 3230"</span></span>
<span><span class="co">#&gt;  [1] "The critical function at nodes in level 2 are 5.32976776663965e-05"</span></span>
<span><span class="co">#&gt;  [2] "The critical function at nodes in level 2 are 3.80697697617118e-05"</span></span>
<span><span class="co">#&gt;  [3] "The critical function at nodes in level 2 are 0.000369699764130401"</span></span>
<span><span class="co">#&gt;  [4] "The critical function at nodes in level 2 are 0.000487293052949911"</span></span>
<span><span class="co">#&gt;  [5] "The critical function at nodes in level 2 are 6.34496162695196e-05"</span></span>
<span><span class="co">#&gt;  [6] "The critical function at nodes in level 2 are 6.34496162695196e-05"</span></span>
<span><span class="co">#&gt;  [7] "The critical function at nodes in level 2 are 2.87638260421822e-05"</span></span>
<span><span class="co">#&gt;  [8] "The critical function at nodes in level 2 are 3.72237748781182e-05"</span></span>
<span><span class="co">#&gt;  [9] "The critical function at nodes in level 2 are 2.53798465078079e-06"</span></span>
<span><span class="co">#&gt; [10] "The critical function at nodes in level 2 are 0.000220804664617928"</span></span>
<span><span class="co">#&gt; [11] "The critical function at nodes in level 2 are 0.000422151446913204"</span></span>
<span><span class="co">#&gt; [12] "The critical function at nodes in level 2 are 4.22997441796798e-05"</span></span>
<span><span class="co">#&gt; [13] "The critical function at nodes in level 2 are 6.51416060367068e-05"</span></span>
<span><span class="co">#&gt; [14] "The critical function at nodes in level 2 are 4.82217083648349e-05"</span></span>
<span><span class="co">#&gt; [15] "The critical function at nodes in level 2 are 1.01519386031231e-05"</span></span>
<span><span class="co">#&gt; [16] "The critical function at nodes in level 2 are 1.35359181374975e-05"</span></span>
<span><span class="co">#&gt; [17] "The critical function at nodes in level 2 are 7.61395395234236e-06"</span></span>
<span><span class="co">#&gt; [1] "Now moving to depth 3"</span></span>
<span><span class="co">#&gt; [1] "The rejected nodes in level 3 are 3161"</span></span>
<span><span class="co">#&gt; [2] "The rejected nodes in level 3 are 3200"</span></span>
<span><span class="co">#&gt; [1] "The critical function at nodes in level 3 are 4.85296943089359e-06"</span></span>
<span><span class="co">#&gt; [2] "The critical function at nodes in level 3 are 1.5367736531163e-05" </span></span>
<span><span class="co">#&gt; [3] "The critical function at nodes in level 3 are 3.23531295392906e-06"</span></span>
<span><span class="co">#&gt; [4] "The critical function at nodes in level 3 are 1.29412518157163e-05"</span></span>
<span><span class="co">#&gt; [5] "The critical function at nodes in level 3 are 0.000294413478807545"</span></span>
<span><span class="co">#&gt; [6] "The critical function at nodes in level 3 are 1.37500800541985e-05"</span></span>
<span><span class="co">#&gt; [7] "The critical function at nodes in level 3 are 8.89711062330492e-06"</span></span>
<span><span class="co">#&gt; [8] "The critical function at nodes in level 3 are 0.000280663398753346"</span></span>
<span><span class="co">#&gt; [9] "The critical function at nodes in level 3 are 5.1765007262865e-05" </span></span>
<span><span class="co">#&gt; [1] "Now moving to depth 4"</span></span>
<span><span class="co">#&gt; [1] "Now moving to depth 5"</span></span>
<span><span class="co">#&gt; [1] "Stop moving to next level because no nodes at depth 5 are rejected."</span></span></code></pre></div>
<ul>
<li><p><code>sigma</code>: standard deviation of noise <span class="math inline">\(\epsilon\)</span>’s, if known. If <code>sigma</code> is non-<code>NULL</code>, then a chi-squared null distribution is used; if <code>sigma</code> is <code>NULL</code>, then an F-test is performed.</p></li>
<li><p><code>tree</code>: a list of length-<span class="math inline">\(|\mathcal{T}\setminus \mathcal{L}|\)</span> that describes the tree structure. This format is a generalization of the <code>merge</code> matrix within an <code>hclust</code> object. The element <code>hc_list[[i]]</code> contains the children of the <span class="math inline">\(i\)</span>-th node on the tree. A negative value indicates that the child is a leaf node while positive values are interior nodes. For example, if <code>hc_list[[i]][j]</code> is positive, that means that node <code>hc_list[[i]]</code> is a parent of node <code>hc_list[[j]]</code>. The object <code>stocks_tree</code> in our package is an example of such a structure. The function can also work with <code>hclust</code> objects (for binary trees) or <code>dendrogram</code> objects (for more general trees). The functions <code>dend_as_hclist</code> and <code>hclist_as_dend</code> allow one to switch between formats.</p></li>
<li><p><code>alpha</code>: target FSR level.</p></li>
</ul>
<p>The output <code>result</code> is a list that has three components: <code>alpha</code> is the target FSR level, <code>groups</code> gives the group assignments of the observations, and <code>rejections</code> indicates if each interior node is rejected (this will come in handy for plotting the aggregation result on a tree).</p>
<p>In this example, the achieved aggregation result contains 40 groups. We plot the achieved aggregation on the tree using the function <code>plot_aggregation</code> (a bit busy as since are &gt;2k stocks…).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_aggregation.html">plot_aggregation</a></span><span class="op">(</span>rejections <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">rejections</span>, tree <span class="op">=</span> <span class="va">stocks_tree</span><span class="op">)</span></span></code></pre></div>
<p><img src="my-vignette_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p><a id="feature"></a></p>
</div>
</div>
<div class="section level2">
<h2 id="application-to-feature-aggregation">Application to feature aggregation<a class="anchor" aria-label="anchor" href="#application-to-feature-aggregation"></a>
</h2>
<p>For this application, we will synthetize data for feature aggregating. We randomly generate a tree with 50 leaves by hierarchical clustering, and cut the tree into 10 disjoint groups. Then we simulate 10 coefficient values corresponding to the 10 groups. To mimick the scenario of rare features (<span class="citation">Yan and Bien (2020)</span>), we generate a design matrix <span class="math inline">\(X\)</span> by a Gaussian-Bernoulli distribution. Finally, we build a linear model with gaussian noise as the response vector <span class="math inline">\(y\)</span>.</p>
<p>To perform aggregation, we can use the function <code>aggregate_features</code>. The input requires</p>
<ul>
<li><p><code>y</code>: response vector.</p></li>
<li><p><code>X</code>: design matrix.</p></li>
<li><p><code>hc</code>: an object that describes the tree structure. Since here we have a binary tree, we use a <code>tree = hclust</code> object. Alternatively, one can also use <code>tree = dendrogram</code> or <code>tree = hc_list</code> if they have a non-binary tree that is saved in the format of ‘dendrogram’ or ‘hc_list’.</p></li>
<li><p><code>alpha</code>: target FSR level.</p></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">agg_result</span> <span class="op">=</span> <span class="fu"><a href="../reference/aggregate_features.html">aggregate_features</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                          tree <span class="op">=</span> <span class="va">hc</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[1].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[2].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[3].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[4].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[5].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[1].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[2].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[3].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[4].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[5].</span></span>
<span><span class="co">#&gt; ##########################</span></span>
<span><span class="co">#&gt; Finished model fits for fold[1].</span></span>
<span><span class="co">#&gt; ##########################</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[1].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[2].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[3].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[4].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[5].</span></span>
<span><span class="co">#&gt; ##########################</span></span>
<span><span class="co">#&gt; Finished model fits for fold[2].</span></span>
<span><span class="co">#&gt; ##########################</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[1].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[2].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[3].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[4].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[5].</span></span>
<span><span class="co">#&gt; ##########################</span></span>
<span><span class="co">#&gt; Finished model fits for fold[3].</span></span>
<span><span class="co">#&gt; ##########################</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[1].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[2].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[3].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[4].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[5].</span></span>
<span><span class="co">#&gt; ##########################</span></span>
<span><span class="co">#&gt; Finished model fits for fold[4].</span></span>
<span><span class="co">#&gt; ##########################</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[1].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[2].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[3].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[4].</span></span>
<span><span class="co">#&gt; Finished model fits for alpha[5].</span></span>
<span><span class="co">#&gt; ##########################</span></span>
<span><span class="co">#&gt; Finished model fits for fold[5].</span></span>
<span><span class="co">#&gt; ##########################</span></span>
<span><span class="co">#&gt; [1] "Nodes 99 at level 1 are rejected."</span></span>
<span><span class="co">#&gt; [1] "Now moving to depth 2"</span></span>
<span><span class="co">#&gt; [1] "The rejected nodes in level 2 are 78"</span></span>
<span><span class="co">#&gt; [1] "The critical function at nodes in level 2 are 0.0331428571428572"</span></span>
<span><span class="co">#&gt; [2] "The critical function at nodes in level 2 are 0.024"             </span></span>
<span><span class="co">#&gt; [1] "Now moving to depth 3"</span></span>
<span><span class="co">#&gt; [1] "The rejected nodes in level 3 are 69"</span></span>
<span><span class="co">#&gt; [1] "The critical function at nodes in level 3 are 0.0200626959247649"</span></span>
<span><span class="co">#&gt; [2] "The critical function at nodes in level 3 are 0.0090282131661442"</span></span>
<span><span class="co">#&gt; [1] "Now moving to depth 4"</span></span>
<span><span class="co">#&gt; [1] "Now moving to depth 5"</span></span>
<span><span class="co">#&gt; [1] "Stop moving to next level because no nodes at depth 5 are rejected."</span></span></code></pre></div>
<p>For calculating FSP we can use</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calculate_fsp.html">calculate_fsp</a></span><span class="op">(</span>theta_est <span class="op">=</span> <span class="va">agg_result</span><span class="op">$</span><span class="va">groups</span>, theta_true <span class="op">=</span> <span class="va">groups</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p><a id="general"></a></p>
</div>
<div class="section level2">
<h2 id="general-example">General example<a class="anchor" aria-label="anchor" href="#general-example"></a>
</h2>
<p>The functions <code>aggregate_observations</code> and <code>aggregate_features</code> shown above both make use of the hierarchical aggregation testing framework introduced in the paper “Controlling the False Split Rate in Tree-Based Aggregation”. Internally, both functions call a more general function called <code>hierarchical_testing</code>. If a user has a different way to construct nodewise p-values for aggregation, then the user should use <code>hierarchical_testing</code> as shown here.</p>
<p>This function takes a length-<code>num_interior_node</code> vector of p-values.</p>
<p>Here is a small example:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">hc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html" class="external-link">hclust</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">de</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/dendrogram.html" class="external-link">as.dendrogram</a></span><span class="op">(</span><span class="va">hc</span><span class="op">)</span></span>
<span><span class="va">hc_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dend_as_hclist.html">dend_as_hclist</a></span><span class="op">(</span><span class="va">de</span><span class="op">)</span></span>
<span></span>
<span><span class="va">compute_my_pvalue</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">u</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Example of a customized pvalue function:</span></span>
<span>  <span class="co"># u an element of hc_list</span></span>
<span></span>
<span>  <span class="co"># compute something more interesting than just runif here.</span></span>
<span>  <span class="co"># If has leaf as a child, not reject; otherwise reject.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">hc_list</span><span class="op">[[</span><span class="va">u</span><span class="op">]</span><span class="op">]</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">result_small</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hierarchical_test.html">hierarchical_test</a></span><span class="op">(</span>tree <span class="op">=</span> <span class="va">hc_list</span>,</span>
<span>                  p_vals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">hc_list</span><span class="op">)</span>, <span class="va">compute_my_pvalue</span><span class="op">)</span>,</span>
<span>                  alpha <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>                  independent <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Nodes 39 at level 1 are rejected."</span></span>
<span><span class="co">#&gt; [1] "Now moving to depth 2"</span></span>
<span><span class="co">#&gt; [1] "The rejected nodes in level 2 are 31"</span></span>
<span><span class="co">#&gt; [2] "The rejected nodes in level 2 are 38"</span></span>
<span><span class="co">#&gt; [1] "The critical function at nodes in level 2 are 0.192"</span></span>
<span><span class="co">#&gt; [2] "The critical function at nodes in level 2 are 0.128"</span></span>
<span><span class="co">#&gt; [1] "Now moving to depth 3"</span></span>
<span><span class="co">#&gt; [1] "The rejected nodes in level 3 are 25"</span></span>
<span><span class="co">#&gt; [2] "The rejected nodes in level 3 are 30"</span></span>
<span><span class="co">#&gt; [3] "The rejected nodes in level 3 are 37"</span></span>
<span><span class="co">#&gt; [1] "The critical function at nodes in level 3 are 0.105329153605016"</span></span>
<span><span class="co">#&gt; [2] "The critical function at nodes in level 3 are 0.105329153605016"</span></span>
<span><span class="co">#&gt; [3] "The critical function at nodes in level 3 are 0.105329153605016"</span></span>
<span><span class="co">#&gt; [1] "Now moving to depth 4"</span></span>
<span><span class="co">#&gt; [1] "Stop moving to next level because no nodes at depth 4 are rejected."</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_aggregation.html">plot_aggregation</a></span><span class="op">(</span>rejections <span class="op">=</span> <span class="va">result_small</span><span class="op">$</span><span class="va">rejections</span>, tree <span class="op">=</span> <span class="va">hc_list</span><span class="op">)</span></span></code></pre></div>
<p><img src="my-vignette_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="section level3 unnumbered">
<h3 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references">
<div id="ref-CRSP">
<p>CRSP Stocks. 2021.</p>
</div>
<div id="ref-Yan2018RareFS">
<p>Yan, Xiaohan, and Jacob Bien. 2020. “Rare Feature Selection in High Dimensions.” <em>Journal of the American Statistical Association</em> 0 (0): 1–14. <a href="https://doi.org/10.1080/01621459.2020.1796677" class="external-link">https://doi.org/10.1080/01621459.2020.1796677</a>.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Simeng Shao.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
